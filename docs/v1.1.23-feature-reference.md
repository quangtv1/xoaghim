# v1.1.23 Feature Quick Reference

**Release Date:** 2026-01-27
**Status:** Stable/Production

---

## New Features Overview

### 1. Sliding Window Preview (Memory Optimization)

**Problem:** Large PDFs (100+ pages) consume excessive memory

**Solution:** Only keep 10 pages in RAM (current ±5 pages)

**Technical Details:**
- Window: Current page ±5 = 10 pages max
- Auto-purges pages outside window
- Seamless scrolling maintained
- Reduces memory footprint by ~60% for large documents

**User Impact:**
- Process huge PDFs without running out of memory
- Smooth preview scrolling regardless of document size
- No visible lag or stuttering

**Code Location:** `ui/continuous_preview.py` (~3,500+ LOC)

**Keyboard:** N/A (automatic)

---

### 2. AI Detection Preload

**Problem:** First text protection toggle has model load delay (3-5 seconds)

**Solution:** Auto-preload YOLO DocLayNet model when protection enabled

**Technical Details:**
- Non-blocking background load
- Loads during user interaction
- Model cached in memory after first load
- Only loads when feature enabled

**User Impact:**
- Eliminates wait when toggling text protection
- Faster batch processing with protection enabled
- Better perceived performance

**Code Location:** `text_protection_dialog.py`, `main_window.py`

**Toggle:** Checkbox "Bảo vệ Text" (Text Protection)

---

### 3. Background File Preload

**Problem:** Batch processing has wait time between consecutive files

**Solution:** Pre-render next file while processing current file

**Technical Details:**
- Works in batch mode only
- Parallel preload with current processing
- Non-blocking operation
- Reduces inter-file delay

**User Impact:**
- Faster batch throughput
- Smoother batch workflow
- Less idle time between files

**Code Location:** `main_window.py`, `batch_sidebar.py`

**Trigger:** Automatic in batch mode

---

### 4. Lazy Page Count Loading

**Problem:** Opening large folders with many files causes UI freeze

**Solution:** Load page counts in batches using ThreadPoolExecutor

**Technical Details:**
- ThreadPoolExecutor with 4 workers
- Batch loading in background
- UI remains responsive
- Progress indicated by status updates

**User Impact:**
- Quick folder load (no blocking)
- Sidebar responsive while counting pages
- Better UX for large batches

**Code Location:** `batch_sidebar.py`

**Trigger:** Automatic when selecting folder

---

### 5. Keyboard Navigation for Batch

**Problem:** Batch file navigation requires mouse

**Solution:** Add [ ] keyboard shortcuts

**Technical Details:**
- **[** = Previous file in batch
- **]** = Next file in batch
- Shortcuts work anywhere in batch mode
- Tooltips display hints

**User Impact:**
- Keyboard-driven batch workflow
- Faster file navigation
- Better accessibility

**Code Location:** `batch_sidebar.py`, `main_window.py`

**Shortcuts:**
```
[ = Previous file
] = Next file
```

---

### 6. Bug Fixes & Stability (v1.1.23)

| Bug | Fix | Impact |
|-----|-----|--------|
| TextProtectionOptions crashes | Changed dict access to dataclass attributes | Fixed crashes when enabling text protection |
| _load_from_cache invalid call | Removed invalid method call, added proper handling | Fixed file loading crashes |
| Panel centering | Fixed centering logic for different page sizes | Fixed misaligned preview panels |

---

## Cumulative v1.1.x Features

### Core Staple Removal
- AI-powered YOLO DocLayNet detection (ONNX Runtime)
- 7-step removal algorithm
- Red/blue signature preservation
- Content protection regions

### Zone Management
- 8 preset zones (4 corners + 4 edges)
- Custom draw mode (Cmd+A / Alt+A)
- Hybrid sizing (pixels + percentage)
- Undo/Redo up to 79 actions (Ctrl+Z)
- Delete key support
- Global/Per-file/Per-page zones

### File Processing
- Single file mode
- Batch folder processing
- Drag & drop support
- Keyboard navigation ([ ] in batch)
- Lazy page count loading
- Background file preload

### Preview & Visualization
- Synchronized split-view (Original | Processed)
- Real-time updates as zones change
- Synchronized scroll/zoom
- Zoom persistence in batch
- Multi-page continuous preview
- Sliding window for memory efficiency (v1.1.23)

### Output & Configuration
- DPI adjustment (72-300)
- JPEG compression
- Persistent config (JSON)
- Auto-recovery on crash
- Sidebar filters (name + page count)
- Zone counter display

### UI Shortcuts
```
Ctrl+Z / Cmd+Z     Undo
Ctrl+Shift+Z       Redo (if supported)
Cmd+A / Alt+A      Draw mode toggle
Cmd+S / Alt+S      Select mode toggle
+                  Zoom in
-                  Zoom out
=                  Reset zoom
[                  Previous file (batch)
]                  Next file (batch)
Delete             Delete selected zone
```

---

## Performance Improvements (v1.1.23)

### Memory Usage
| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| 100-page PDF | ~500 MB | ~200 MB | 60% reduction |
| 1000-page PDF | OOM | ~400 MB | Feasible now |

### Processing Speed
| Operation | Time | Note |
|-----------|------|------|
| Sliding window setup | <50ms | One-time cost |
| Page preload (background) | Non-blocking | Parallel |
| Page count load | <100ms | Per batch item |
| AI model preload | <2s | Background, user doesn't wait |

### Responsiveness
| Action | Improvement |
|--------|-------------|
| Open large folder | UI stays responsive (lazy counting) |
| Toggle text protection | Faster (preloaded model) |
| Switch batch files | Faster (background preload) |
| Scroll large document | Smooth (sliding window) |

---

## Implementation Details

### Sliding Window Preview

```python
# Keep 10-page window in RAM
window_size = 10
current_page = 47

# Pages to keep: 42-52 (±5 from current)
min_page = max(0, current_page - 5)
max_page = min(total_pages - 1, current_page + 5)

# Auto-purge pages outside window
for page in cached_pages:
    if page < min_page or page > max_page:
        del cached_pages[page]
```

### AI Detection Preload

```python
# In background thread
if text_protection_enabled:
    if not model_loaded:
        # Non-blocking load
        executor.submit(load_ai_model)
```

### Lazy Page Count Loading

```python
# Load page counts in parallel
with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [
        executor.submit(get_page_count, file)
        for file in files
    ]
    # Update UI as results arrive
    for future in as_completed(futures):
        update_sidebar_with_count(future.result())
```

---

## Testing Checklist

- ✅ Sliding window prevents memory overflow on 1000+ page PDFs
- ✅ AI preload doesn't block UI on first text protection toggle
- ✅ Background preload completes before switching files
- ✅ Lazy page count loading keeps sidebar responsive
- ✅ Keyboard [ ] shortcuts work in batch mode
- ✅ TextProtectionOptions access doesn't crash
- ✅ Panel centering works with different page sizes
- ✅ All features work on Windows, macOS, Linux

---

## Troubleshooting

### "Memory still high with sliding window"
- **Cause:** Other components consuming memory
- **Solution:** Close other applications, restart app
- **Note:** Sliding window is for preview only; processing may need more

### "AI preload takes too long"
- **Cause:** First-time model download (~100 MB)
- **Solution:** Wait for initial download, then cached
- **Note:** Subsequent uses are much faster

### "Keyboard [ ] not working"
- **Cause:** Wrong mode (not in batch)
- **Solution:** Open batch mode (folder) first
- **Note:** [ ] only works in batch mode with file list

### "Page count loading stalls"
- **Cause:** Very large folder (1000+ files)
- **Solution:** Filter by file name to reduce load
- **Note:** Loading happens in background; sidebar should remain responsive

---

## Migration Notes

**From v1.1.22 to v1.1.23:**
- ✅ No breaking changes
- ✅ Config files compatible
- ✅ Existing zones work as-is
- ✅ No data migration needed

**Upgrade Path:**
1. Close application
2. Replace with v1.1.23 build
3. Restart application
4. All previous settings preserved

---

## Known Limitations

| Limitation | Workaround |
|-----------|-----------|
| Sliding window only in preview | Can increase RAM for processing |
| AI preload takes time on first use | Model cached after first load |
| Page counting can be slow for 1000+ files | Filter files by name first |
| Keyboard nav [ ] batch only | Use mouse in single-file mode |

---

## What Changed Under the Hood

### continuous_preview.py
- Added `sliding_window_mode` tracking
- Implemented page cache purging logic
- Updated rendering to maintain 10-page window

### batch_sidebar.py
- Added `ThreadPoolExecutor` for page count loading
- Added keyboard event handlers for [ ]
- Added background preload trigger

### main_window.py
- Added AI preload signal/slot connections
- Added background file preload orchestration
- Added keyboard [ ] shortcut mapping

### text_protection_dialog.py
- Added AI model preload on toggle enable

---

## Future Optimizations

**Planned for v1.2.0:**
- [ ] GPU acceleration for AI model (if available)
- [ ] Further memory optimization (streaming)
- [ ] Batch processing parallelization

**Planned for v1.3.0:**
- [ ] Zone profile templates
- [ ] Smart zone auto-detection

---

## Feedback & Issues

**Report Issues:** [GitHub Issues](https://github.com/quangtv1/xoaghim/issues)

**Feature Requests:** [GitHub Discussions](https://github.com/quangtv1/xoaghim/discussions)

---

## Document Info

- **Version:** 1.0
- **Last Updated:** 2026-01-27
- **Status:** Complete
- **Target Audience:** Users, Developers
